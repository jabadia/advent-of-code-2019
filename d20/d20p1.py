from collections import defaultdict

from utils.test_case import TestCase
import heapq

INPUT = """
                                     L           D A A             K     R   Y                                             
                                     N           E A W             C     Y   L                                             
  ###################################.###########.#.#.#############.#####.###.###########################################  
  #...#...#.#.......#...........#...#.....#.#.#.....#.....#.#...#.....#.....#.#.#.....#...#.............#.....#.#.....#.#  
  ###.###.#.#######.#######.###.###.#.#####.#.###.#.#.#####.###.#.#.#.###.#.#.#.#.#####.###.#.###############.#.#.###.#.#  
  #.......#...#.......#...#.#.........#.#.#.....#.#.#...#...#.#...#.#.#...#.#.#.#...#...#.#.#.#.#...#.#.#.#.#.......#.#.#  
  #.###.#.#.#######.#.###.###.#####.#.#.#.###.#####.#.#####.#.#.###########.#.###.#.#.###.###.#.#.###.#.#.#.#.#.#####.#.#  
  #.#.#.#.#.#...#...#...#.....#.....#.....#.#.#.#...#...#.....#.......#...#.#.....#...#.#.#.#...........#.#.#.#...#.....#  
  ###.###.#.#.#.#######.#####.#######.#####.#.#.###.###.#.#.###.###.#####.#.#####.#.###.#.#.#.#####.###.#.#.###########.#  
  #.........#.#.....#.....#.#...#...#...#.#.......#.#.....#.#.....#.#...........#.#.#.....#.......#.#.#...#.#.#...#...#.#  
  ###.###.#########.###.#.#.#.###.###.###.###.###.#.###.###.#######.#######.###.###.#.###.#.#.#.###.#.#####.#.###.###.#.#  
  #...#.......#.#.....#.#.......#.......#.....#.......#.#.....#.#.#.....#.....#.#.....#...#.#.#...#.#...#.......#...#...#  
  #######.#.#.#.#.#.#######.#.#####.#.#######.#.#.#.#####.#####.#.#.#####.#.#######.#######.#########.#####.#####.#####.#  
  #...#...#.#...#.#.........#.#.....#.#.......#.#.#.#.....#...#.#...#...#.#.#.........#...........#.#.......#...#.......#  
  ###.#######.#####.#####.#.###.#####.###.###.#######.#####.###.#.#.#.#####.###.#.#.###.###.#######.#######.#.#####.#.#.#  
  #.....#.#.#.#.#...#.#...#.#.#.#.#.#...#.#.....#.............#...#...#.......#.#.#...#.#.#.#...#.....#...#.....#.#.#.#.#  
  #.###.#.#.#.#.###.#.#######.###.#.#.#######.#########.###.#####.#.#######.#####.#.###.#.###.#####.#####.###.###.###.###  
  #.#.............#.#...#.....#.........#.#.#.#...#...#.#...#...#.#.#...#.......#.#.#.......#...#...#.#.....#.#.#...#...#  
  ###.###.#######.#.###.###.#####.#.#.###.#.#.#.###.###.###.#.#####.#.#####.#######.#.###.###.###.###.#.#.#.#.#.###.#.###  
  #.....#.#.#.#.......#.#.....#...#.#.......#...#.....#.#.......#.....#.#.......#.....#.....#.#.....#.#.#.#.....#...#...#  
  #########.#.#.###.###.###.#####.#####.#.#.#.#####.#######.#######.#.#.#.#.#######.#######.#.#.###.#.#####.###.###.#.###  
  #...#.#.......#.#.#.#...........#...#.#.#.#...#.....#.....#...#...#.#...#.#.........#...#.......#.#.#.#...#.#.#.....#.#  
  #.###.#.#.#####.###.#.###.#.#.#####.#.#######.#.#.#####.#.#.#####.#.#####.#.###########.###.#.#####.#.#####.#.###.###.#  
  #.#.....#...#.....#...#...#.#.....#.....#.......#.#.#...#.#...#...#.#.....#.#.....#...#.#.#.#.#...#...#.....#...#.#...#  
  #.#####.#.#####.###########.#######.#############.#.###.###.#.#.###.###.#.#.#.#.#.#.#.#.#.#####.#####.###.#.#.###.#.#.#  
  #.#.....#...#...#...#.#.#.#.#.......#.#...#...........#...#.#.....#.#.#.#.#...#.#...#.#.#...#.#.....#.....#...#.....#.#  
  #.###########.#.###.#.#.#.#.#######.#.#.#######.#########.#.#########.#.#######.#.#.###.#.###.#.###.#.#######.###.#####  
  #.......#.#...#...........#.#.......#.#.#.....#.....#...#.#.......#.#...#.......#.#.............#.#.#.#...#.......#...#  
  #.#####.#.#.###.#####.#######.#.###.#.#.###.#.###.###.#.#.#####.###.#.#.#######.#########.#.#####.#######.###.#.###.###  
  #.#.#.....#.#.....#.#...#.#.#.#.#.........#.#...#.....#.#.#.#.....#...#...#...#.......#.#.#.#.#.#.#...#...#.#.#.....#.#  
  ###.#####.###.#####.#.###.#.#####.#######.#.###.#.#######.#.#.###.#.#########.###.#.###.#####.#.#.#.###.###.#####.###.#  
  #.#.#...#...#.#.#.#...#.......#...#...#...#...#...#.........#.#...#.....#.#.......#...#.#...#.#...#.#...#...#.....#...#  
  #.#.#.###.#####.#.###.#####.#.#######.###.###.###.#####.#######.#.#.#####.#.#######.###.###.#.#.###.#.#####.#####.#.#.#  
  #.#.......#.............#...#.............#.....#.#.........#...#.#...#...........#...#.#.#.....#.....#.#.....#.....#.#  
  #.#####.#####.#.#.#.###.#######.#######.###.###########.#####.#######.#######.#########.#.#.###.###.###.###.#####.#####  
  #.#.#.#.....#.#.#.#.#.#.#.......#      X   A           U     R       T       G        #...#.#...#.#.....#.#.#.#.#...#.#  
  #.#.#.#.#########.###.#.#####.#.#      F   I           F     Y       Z       O        ###.###.###.###.###.#.#.#.###.#.#  
  #...#...#...#.......#...#.#...#.#                                                     #.#.#.#...#...#.....#.....#.#...#  
  ###.###.###.#########.#.#.#######                                                     #.#.#.###.#.#####.#####.###.###.#  
  #.#.....#.........#.#.#.....#.#.#                                                   GP..................#.......#.....#  
  #.#####.#.#########.#######.#.#.#                                                     ###.#.###.#.#####.#.###.#.#.#.#.#  
  #...#.#.......#.#.#.#.#.........#                                                     #...#.#.#.#...#.....#...#...#.#..TZ
  #.###.#.#######.#.#.#.###.###.#.#                                                     #######.#########################  
FB......#.#...#.#.#.........#...#.#                                                     #.....#.........#.......#........GP
  #.#####.#.###.#.#####.###.#.#####                                                     #.###.#.#####.#.#.#####.#.#####.#  
  #...#...........#.#...#.#.#.#....EF                                                   #.#...#.....#.#...#.....#...#...#  
  #.#####.#.###.#.#.#####.#.#.###.#                                                     #.#.#.###.#######.#.#######.###.#  
  #.......#.#...#...........#.....#                                                   FB..#.#.#.......#.#.#...#.....#...#  
  #.#.#.###.#########.###########.#                                                     #.#.###.#######.#.#.#.###.#.#####  
  #.#.#...#.#...#...#...#.....#.#.#                                                     #.#.............#.#.#.....#.#...#  
  ###.#######.###.#######.###.#.###                                                     ###.###.###.#.###.#.#.#######.###  
UB..#...#.....#...#...#.#.#.......#                                                     #.#.#.#...#.#...#.#.#.#...#.....#  
  #.#######.#.###.###.#.#.#.#.#.#.#                                                     #.###.###########.#.###.#.#.###.#  
  #.#...#...#.#...#.....#.#.#.#.#..UQ                                                 LC..#.....#.#.#.#.#.#.#...#...#...#  
  #.#.#.#.#.###.#.#.#.###.###.#####                                                     #.#.###.#.#.#.#.#######.###.#.###  
  #...#...#.....#...#.....#...#.#.#                                                     #.....#.#...#.#.#...#.#...#.#.#.#  
  #############################.#.#                                                     ###.#.#.#.###.#.###.#.#.#####.#.#  
  #.........#.#...................#                                                     #...#.#...................#......MA
  ###.#####.#.#.###.###.#######.#.#                                                     #########.#######################  
  #...#.....#.....#.#.......#...#.#                                                     #.......#.#.#.#.........#...#....RR
  #.#.#.#.###.#.#######.#####.#####                                                     #.#####.###.#.#.###.#.###.#.#.#.#  
LW..#.#.#.....#.#...#.#...#...#....KC                                                 UB......#.#.......#...#.....#...#.#  
  #.#######.#####.###.#######.###.#                                                     ###.###.###.#.#.###.#.#######.#.#  
  #.#.....#.#.#.#.#...#.#.#.......#                                                   AW....#...#...#.#.#...#...#.#.#.#..EF
  ###.#######.#.#.###.#.#.###.#####                                                     #.###.###.#.#############.#.#.###  
  #.............#...........#.#...#                                                     #.#.#.....#.#.#...#.....#.#.....#  
  #.###.#.#.###.#.###.#.#.#.###.#.#                                                     ###.###.#####.#.#####.###.#######  
  #.#...#.#.#.....#...#.#.#.....#..TF                                                 PF....#.....#.....#.#.............#  
  #.###.#########.#########.###.#.#                                                     #.#########.###.#.#.#####.#######  
UQ..#.....#.#...#.#.#.#...#.#.#.#.#                                                     #.#.#.#...#...#...#.#.....#...#.#  
  ###.#####.#.###.#.#.#.#####.#.###                                                     #.#.#.###.#.#.###.#.#.#####.###.#  
  #.#.#.......#.#.#.....#.....#.#.#                                                     #.#...#.#.#.#.#...#.#.#..........AI
  #.#########.#.###.#.#.#.###.###.#                                                     #.#.#.#.#.#.#.###.#.#.#####.###.#  
GO....#.#.#.#...#.#.#.#.....#.#...#                                                     #...#.......#.#.....#.......#.#.#  
  #.###.#.#.#.###.###.#.#####.#.#.#                                                     #####################.#######.###  
  #.......#...#.....#.#...#.#.#.#..LW                                                   #...................#...#........QY
  #.###.#.#.#.###.#.#.#.###.#.#.###                                                     #.#.#####.#.###.###.#####.#.###.#  
  #.#...#...#.....#...#...#.......#                                                     #.#...#...#...#.#...#.#.#.#.#...#  
  #####.###.#.###.#################                                                     ###.#########.#.#.#.#.#.###.###.#  
  #...#.#...#.#.......#.#...#.....#                                                   MA..#...#...#...#.#.#.......#.#.#.#  
  ###.#.###.#########.#.#.#.#.###.#                                                     #.#.#####.###########.#.#.#.#.#.#  
  #...#.#.#.#.......#.#...#...#....YC                                                   #.....#...#.#...#.#.#.#.#.....#.#  
  #.#.###.#########.###.#######.#.#                                                     #########.#.#.###.#.#############  
  #.#...#.#.#.#.#.....#.......#.#.#                                                     #.#.....#.......#...........#...#  
  ###.###.#.#.#.###.#.#####.#.###.#                                                     #.#.###.#.#####.#.###.#.#.#.#.###  
TF..................#.......#.#.#.#                                                     #.#...#.......#.....#.#.#.#......UF
  #.#.#.#####.###.#.#.###.#.###.###                                                     #.###.###.#.###.#.#######.#.###.#  
  #.#.#...#.....#.#.#...#.#.......#                                                   QY..#.....#.#.#...#...#.#...#.#...#  
  #.###.#.###.#.###.#.#####.###.#.#                                                     #.#.#.#.#########.###.#.#.#####.#  
  #.#.#.#.#...#...#.#.#.#...#...#.#                                                     #...#.#...#.........#...#.....#.#  
  #.#.###.###.#.#####.#.#.#.#.#####    R         T       D Y         W L           R    ###.#.#.###.#.#####.#.#####.#####  
  #.....#.#.#.#.....#...#.#.#.....#    R         B       E L         T N           A    #...#.#.#...#.....#.#.#.......#.#  
  #.#.#####.#.#####.#.###.#####.#######.#########.#######.#.#########.#.###########.###########.#####.#.###.#######.###.#  
  #.#.#.#.......#.#.#.#.#...#.#.#...#.....#.......#...#...#...#.......#...#...#.......#.#.#...#...#...#.#.......#.......#  
  ###.#.#.#####.#.#####.#.#.#.###.###.###.#######.#.#.###.#.#.#.#######.###.#.#.#######.#.###.#.#####.#####.#.#.###.#.###  
  #.....#.....#...#.....#.#.#...........#...#...#.#.#...#.#.#.#.#...#.......#.#...#.........#...#.#.....#...#.#.#...#...#  
  ###.###.#.#####.###.###.#####.#.#.#####.#####.#.#.###.#.###.#.#.#.#########.###.#.#####.#.###.#.#####.#.#.###.###.#.###  
  #.....#.#.#.......#.#.#...#...#.#.#.#...#.#.#.#.#.#.....#.#.#...#.....#.#...#.......#.#.#...#.....#...#.#.#.....#.#...#  
  ###.###.#######.###.#.#######.#####.###.#.#.#.#.#.#######.#.#####.###.#.#.#####.#.###.#####.#.#.#####.###.#######.###.#  
  #...#...#.................#.#.#.#.#.......#.....#.#.....#.#.#.#...#.#.#.#.#.#...#.#.#...#.#.#.#.#.......#...#.......#.#  
  ###.#########.#####.#.#####.###.#.###.###.###.###.#.###.#.#.#.###.#.###.#.#.#.#.###.###.#.#####.#####.#.#####.#.#.###.#  
  #.......#.....#...#.#.....#...#.......#...#.....#.....#...#.#.......#...#...#.#.#...........#.#.#.#...#.#...#.#.#...#.#  
  ###.#####.###.###.#.###.###.#.###.#####.#.#####.#######.###.#####.#####.#.#.#.###.###.#.###.#.###.#.#######.#.#####.#.#  
  #.......#.#...#...#.#.....#.#.....#.....#.#.....#.......#...#...#...#...#.#.#.......#.#...#.......#.#.#.........#...#.#  
  #.#.#.#.#.#.#####.#.#####.###.#####.#####.###.###.#.#.#####.#.#.###.#.#.###.#####.#######.###########.#####.#.#######.#  
  #.#.#.#.#.#...#.......#...#...#.....#.....#.#...#.#.#...#...#.#.....#.#.....#.......#...#.#.#...........#...#...#.....#  
  ###.#.#####.#####.#.#.###.#######.#####.###.###.#.#######.###.#######.#####.#.#.#######.###.###.#####.#####.#.#####.###  
  #...#...#.....#...#.#.#.....#.#...#.#.......#.#.#.....#.....#...#.#...#.#...#.#.....#.#...#.#.#.#.#...#.....#...#.....#  
  #####.#####.#####.#.#.###.###.#####.###.#####.#.#.#####.###.#.###.###.#.###.#.#######.#.###.#.#.#.#####.#####.#.#.#.###  
  #.....#.#...#.....#.#.#...#.#.............#...#.#.#.#.....#.#...#.........#.#...#.#...#.....#.#.....#.#.#.....#.#.#...#  
  #####.#.#####.#####.#######.#.#.#####.###.#.###.#.#.#######.#.#.#.#####.#.#.#.###.#.###.#####.#.#.###.#####.#.###.#.###  
  #.#.........#.#.....#.#...#.#.#.#.#...#...#.#...#...#.....#.#.#.#...#...#.#.#...................#...#...#.#.#...#.#...#  
  #.#.#.###.#######.###.###.#.#####.#####.###.###.#.#.###.###.#.#######.#######.#.#.#.#.#######.###.#.#.###.#.###.#.#.###  
  #...#...#.#.....#...#...#.#...#.#.#.......#.#...#.#...#.#...#.#.#.....#.....#.#.#.#.#.....#...#.#.#...#.......#.#.#.#.#  
  #.#.#######.#.###.#####.#.###.#.#.###.#####.#.###.#####.###.#.#.###.#.###.###.###.#.#######.###.#.#####.#.#######.###.#  
  #.#.#.#.#.#.#.....#...#...............#.........#.#.#.#.....#.....#.#.#.....#...#.#.#...#.......#.....#.#.......#.....#  
  #.#.#.#.#.###.#######.#.###.#######.###########.#.#.#.###.###.#.#.###.###.#########.#.###.#.#.#.###.#####.#######.###.#  
  #.#.#.#...#.....#.......#...#.#.#...#...#.#.#.#.#.....#.....#.#.#.#...#...#.#.....#.#.#...#.#.#...#...#.#.......#...#.#  
  ###.#.###.#.#.#####.#########.#.###.###.#.#.#.#.#####.#####.###.#####.#.###.#####.#.#.###.###.#####.###.#####.#.#.###.#  
  #...#.......#.....#.#.#.#.#.........#.#.........#...#...#...#...#...#...#.....#.........#.#.#.....#.........#.#.#.#.#.#  
  #.###.#.###.###.#####.#.#.#.#####.#.#.#.#####.###.#.###.###.#.###.###.###.#.#######.#######.#######.#####.###.#####.###  
  #.#...#.#...#...#...........#.#...#.#...#.......#.#...#.#...#.......#.....#.#.#.....#.#.....#.#...#.....#.#.....#.#...#  
  #.#####.#.#####.###.#.#.#.#.#.#.#.#.###########.#.###.#.###.#####.#.#.#####.#.#.#.###.###.###.#.#####.#.#.#.#.###.#.###  
  #...#...#...#...#...#.#.#.#.#...#.#.....#.......#...#...#...#.....#.#...#.....#.#...................#.#.#.#.#.........#  
  #####################################.#####.#######.#######.###.#.#######.#########.###################################  
                                       P     W       Y       R   Z X       L         T                                     
                                       F     T       C       A   Z F       C         B                                     
"""

TEST_CASES = [
    TestCase("""
         A           
         A           
  #######.#########  
  #######.........#  
  #######.#######.#  
  #######.#######.#  
  #######.#######.#  
  #####  B    ###.#  
BC...##  C    ###.#  
  ##.##       ###.#  
  ##...DE  F  ###.#  
  #####    G  ###.#  
  #########.#####.#  
DE..#######...###.#  
  #.#########.###.#  
FG..#########.....#  
  ###########.#####  
             Z       
             Z       
""", 23),
    TestCase("""
                   A               
                   A               
  #################.#############  
  #.#...#...................#.#.#  
  #.#.#.###.###.###.#########.#.#  
  #.#.#.......#...#.....#.#.#...#  
  #.#########.###.#####.#.#.###.#  
  #.............#.#.....#.......#  
  ###.###########.###.#####.#.#.#  
  #.....#        A   C    #.#.#.#  
  #######        S   P    #####.#  
  #.#...#                 #......VT
  #.#.#.#                 #.#####  
  #...#.#               YN....#.#  
  #.###.#                 #####.#  
DI....#.#                 #.....#  
  #####.#                 #.###.#  
ZZ......#               QG....#..AS
  ###.###                 #######  
JO..#.#.#                 #.....#  
  #.#.#.#                 ###.#.#  
  #...#..DI             BU....#..LF
  #####.#                 #.#####  
YN......#               VT..#....QG
  #.###.#                 #.###.#  
  #.#...#                 #.....#  
  ###.###    J L     J    #.#.###  
  #.....#    O F     P    #.#...#  
  #.###.#####.#.#####.#####.###.#  
  #...#.#.#...#.....#.....#.#...#  
  #.#####.###.###.#.#.#########.#  
  #...#.#.....#...#.#.#.#.....#.#  
  #.###.#####.###.###.#.#.#######  
  #.#.........#...#.............#  
  #########.###.###.#############  
           B   J   C               
           U   P   P               
""", 58),
]


def move(pos, direction):
    y, x = pos
    if direction == '<':
        return y, x - 1
    elif direction == '^':
        return y - 1, x
    elif direction == '>':
        return y, x + 1
    elif direction == 'v':
        return y + 1, x


def bfs(maze, portals, start):
    visited, queue = set(), [(0, start)]
    graph = {}
    while queue:
        dist, vertex = heapq.heappop(queue)
        if vertex not in visited:
            visited.add(vertex)
            for direction in '<^>v':
                pos = move(vertex, direction)
                portal = portals.get(pos)
                if portal and pos != start:
                    graph[portal] = dist + 1
                elif maze.get(pos) == '.':
                    heapq.heappush(queue, (dist + 1, pos))
    return graph


def solve(input):
    lines = list(filter(None, input.split('\n')))
    lines = [('*' * (len(lines[0]) + 2))] + ['*' + line + '*' for line in lines] + [('*' * (len(lines[0]) + 2))]
    maze = {}
    portals = {}
    for y, line in enumerate(lines):
        for x, c in enumerate(line):
            if c in '.#':
                maze[(y, x)] = c
            elif c.isalpha():
                if lines[y+1][x].isalpha() and lines[y+2][x] == '.':  # down
                    portals[(y+2, x)] = ''.join(sorted([c, lines[y+1][x]]))
                elif lines[y-1][x].isalpha() and lines[y-2][x] == '.':  # up
                    portals[(y-2, x)] = ''.join(sorted([c, lines[y-1][x]]))
                elif lines[y][x - 1].isalpha() and lines[y][x - 2] == '.':  # left
                    portals[(y, x - 2)] = ''.join(sorted([c, lines[y][x - 1]]))
                elif lines[y][x+1].isalpha() and lines[y][x+2] == '.':  # right
                    portals[(y, x+2)] = ''.join(sorted([c, lines[y][x+1]]))

    # print(portals)

    graph = defaultdict(dict)
    for pos, portal in portals.items():
        graph[portal].update(bfs(maze, portals, pos))

    # print(graph)

    # shortest path
    visited, queue = set(), [(0, 'AA')]
    while queue:
        dist, vertex = queue.pop(0)  # heapq.heappop(queue)
        # print(dist, vertex, queue, graph[vertex])
        if vertex not in visited:
            visited.add(vertex)
            if vertex == 'ZZ':
                return dist - 1
            for next_vertex, next_dist in graph[vertex].items():
                # heapq.heappush(queue, (dist + next_dist, next_vertex))
                queue.append((dist + 1 + next_dist, next_vertex))
            queue = sorted(queue)

    return None


if __name__ == '__main__':
    for case in TEST_CASES:
        result = solve(case.case)
        case.check(result)

    print(solve(INPUT))
